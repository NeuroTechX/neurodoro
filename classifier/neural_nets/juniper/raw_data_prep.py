# gcloud compute --project "euphoric-coral-122514" scp data/training_eeg.csv tajumulco:~/neurodoro/classifier/neural_nets/juniper/data --zone "us-east1-c"




import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import sklearn as sk
from sklearn.linear_model import LinearRegression
from os import walk
from os import listdir
from os.path import isfile, join
from sklearn.model_selection import train_test_split
from sklearn.neighbors import KNeighborsClassifier
from sklearn.neighbors import KNeighborsRegressor
from sklearn.pipeline import make_pipeline
from sklearn.metrics import accuracy_score
from math import sqrt
import pyriemann
from mne import create_info, concatenate_raws
from mne.io import RawArray
from mne.channels import read_montage
from glob import glob
# from pyriemann.utils.viz import plt, plot_confusion_matrix, plot_embedding
from pyriemann.estimation import Covariances, HankelCovariances
from pyriemann.tangentspace import TangentSpace
from pyriemann.clustering import Potato

# Here are the good raw datasets

a = pd.read_csv("data/muse_data/Dano-08-11-RawEEG3.csv", header=0, index_col=False)
b = pd.read_csv("data/muse_data/Dano-08-11-RawEEG0.csv", header=0, index_col=False)
c = pd.read_csv("data/muse_data/josh_sep_21RawEEG2.csv", header=0, index_col=False)
d = pd.read_csv("data/muse_data/josh_sep_21_distracted_RawEEG0.csv", header=0, index_col=False)
e = pd.read_csv("data/muse_data/josh-raw-aug11RawEEG2.csv", header=0, index_col=False)

# Add them all together
data = [a,b,c,d,e]
data = pd.concat(data, ignore_index=True)
data = data[data.Difficulty > -200]
data = data[data.Difficulty != 0]
data.clip(lower=1)
data = data.drop('Timestamp (ms)', axis = 1)
data = data.reset_index(drop=True)

sfreq = 256

# name of each channels 
ch_names = ['Difficulty', 'Performance', 'TP9', 'FP1', 'FP2', 'TP10']

# type of each channels
ch_types = ['stim'] * 2 + ['eeg'] * 4
montage = read_montage('standard_1005')

# get data and exclude Aux channel
#data = data.values[:,-6:].T
print(data.shape)

# convert in Volts (from uVolts)
#data[:-1] *= 1e-6

# create mne objects
#info = create_info(ch_names=ch_names, ch_types=ch_types, sfreq=sfreq, montage=montage)
#raw = (RawArray(data=data, info=info))

# Setting up band-pass filter from 2 - 50 Hz
#raw.filter(2, 50, method='iir')

## Plot the PSD of the EEG data just to make sure it looks alright
#raw.plot_psd(picks=[2]);

#from mne import make_fixed_length_events, Epochs

# Make an events array with epoch times every .5 seconds
#event = make_fixed_length_events(raw, 1, duration=0.5)

# Make an epochs array object from the raw dataset with events array event, length of 2 seconds
#epochs = Epochs(raw, event, tmin=0, tmax=4, preload=True)

def difficulty_class(diff_perf):
    # This was our distracted criteria
    if diff_perf[0] < 50 and diff_perf[1] < 60:
    # if diff_perf[0] > 60:
        return [1]
    else:
        return [0]

#X = raw.copy().pick_types(eeg=True).get_data()
#diff_perf = raw.copy().pick_types(eeg=False, stim=True).get_data().mean(axis=1)
X = data.values[:,2:6]
diff_perf = data.values[:,0:2]
y = np.apply_along_axis(difficulty_class, 1, diff_perf)
#y = np.reshape(y, (len(y),1))
print(X.shape, y.shape)

# Let's transform our data into a covariance matrix and a tangentspace
# covs = Covariances(estimator='lwf').fit_transform(X)
# tans = TangentSpace().fit_transform(covs)

output_data = np.concatenate((y, X), axis=1)

split = int(len(output_data) / 3)
train = pd.DataFrame(output_data[:len(output_data)-split,:])
valid = pd.DataFrame(output_data[len(output_data)-split:,:])

train.to_csv('~/neurodoro/classifier/neural_nets/juniper/data/raw_training_eeg.csv', header=False, index=False)
valid.to_csv('~/neurodoro/classifier/neural_nets/juniper/data/raw_valid_eeg.csv', header=False, index=False)
